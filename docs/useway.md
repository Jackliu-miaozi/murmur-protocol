# Viliage Protocol 使用场景描述 (V2 极简架构版)

本文档描述了 Viliage Protocol 基于 V2 极简架构（链上资产+链下业务）的使用场景，展示了从质押到 NFT 铸造的完整流程。

核心理念：**资产安全在链上，交互体验在链下。**

---

## 场景设定

Alice 想要发起一个关于"Web3 未来发展方向"的 24 小时实时讨论，并将精彩讨论内容铸造成 NFT 永久保存。

---

## 完整使用流程

### 第 1 步：质押入场 (On-Chain)

**时间：2024 年 1 月 1 日 00:00**

在使用协议前，用户需要先获得“发言权”（VP）。

1. **铸造 vDOT**：Alice 使用 1000 DOT 铸造 1000 vDOT（ERC-20）。
2. **质押获得 VP**：
   - Alice 调用 `VPToken.stakeVdot(1000)`。
   - 合约锁定 vDOT，铸造 VP（ERC-1155）。
   - 公式：`VP = 100 * √vDOT`（约 3162 VP）。
   - **Gas 支付**：这是用户为数不多需要支付 Gas 的环节。

---

### 第 2 步：创建议题 (Off-Chain)

**时间：2024 年 1 月 1 日 00:05**

Alice 在 Murmur 前端创建议题。

1. **调用 API**：前端向后端发送创建请求。
2. **扣除 VP**：后端数据库扣除 Alice 的 VP 余额（1000 VP）。
   - **无 Gas**：无需链上交易，操作瞬间完成。
3. **议题上线**：后端生成议题页面，状态为 `Live`。
   - 参数：24 小时，10 分钟冻结窗口，精选上限 50 条。
4. **元数据**：标题、描述等存储在后端数据库（定期备份至 IPFS）。

---

### 第 3 步：讨论与创作 (Off-Chain)

**时间：2024 年 1 月 1 日 00:30**

Bob 参与讨论，体验类似 Web2 社交应用。

1. **发布消息**：

   - Bob 发送："Web3 的核心是去中心化身份..."
   - 后端计算 VP 成本：`Cost = Base(10) × Intensity(AI评分) × Length`。
   - **后端记账**：Bob 的 VP 余额在数据库中扣除，消息立即显示。
   - **AI 评分**：后端无缝调用 AI 模型评估表达强度，无需链上验证。

2. **点赞互动**：

   - Charlie 点赞 Bob 的消息。
   - 后端扣除 Charlie 1 VP，更新消息点赞数。
   - **实时反馈**：点赞数即时更新，无需等待区块确认。

3. **动态精选**：
   - 后端算法实时维护“Top 50 精选列表”。
   - 当有新消息点赞数超越榜单末位时，自动替换更新。

#### VP 动态恢复机制 (Recovery)

为了维持社区活力，系统引入“呼吸与共鸣”恢复模型。**注意：用户恢复后的 VP 总额永远不会超过其初始质押获得的上限。**

1. **自然呼吸 (Time-based)**：

   - 就像体力恢复一样，VP 会随时间缓慢回充。
   - **速率**：每小时恢复上限的 **10%**（例如上限 3000，每小时回血 300）。
   - 目的：保障用户的基本参与权，避免因一时活跃而后续彻底失声。

2. **共鸣回响 (Merit-based)**：
   - 优质内容获得社区认可时，系统给予 VP 奖励（降低实际发言成本）。
   - **点赞回血**：每收到一个点赞，恢复该消息消耗成本的 **20%**。
   - **入选精选**：若消息进入 Top 50，一次性奖励 **500 VP**（作为高光时刻奖励）。

---

### 第 4 步：定期结算 (Batch Settlement)

**时间：每小时执行一次**

为了保持链上 VP 余额与业务消耗一致，系统进行批量结算。

1. **操作员执行**：Murmur 后端生成结算清单（过去 1 小时所有用户的 VP 消耗）。
2. **批量上链**：
   - 后端生成 EIP-712 签名。
   - 提交交易：`VPToken.batchBurn(users[], amounts[], signature)`。
3. **结果**：链上 VP 余额更新，与业务状态同步。

---

### 第 5 步：铸造 NFT 记忆 (On-Chain)

**时间：2024 年 1 月 2 日 00:10**

议题结束，进入历史归档阶段。

1. **议题结算**：后端将议题状态标记为 `Closed`。
2. **计算终局数据**：
   - 确定最终的 50 条精选消息。
   - 计算精选哈希：`curatedHash = keccak256(sortedMessageIds)`。
   - 统计所有参与者的 VP 返还金额（所有消耗的 VP）。
3. **生成铸造签名**：
   - 后端为该议题生成一个包含以上所有信息的“铸造通行证”。
4. **用户铸造**：
   - Alice（或任何参与者）点击“铸造 NFT”。
   - 前端调用 `MurmurNFT.mintWithSignature(...)`。
   - **原子化交易**：
     - ✅ 铸造 NFT 给 Alice。
     - ✅ 将 `curatedHash` 用于 NFT 属性（永恒存证）。
     - ✅ **自动返还** 所有参与者的 VP（合约内部批量 mint）。
5. **结果**：议题变为 `Minted`，所有人的 VP 回到账户，NFT 诞生。

---

### 第 6 步：灵活撤资 (Flexible Exit & Draining)

**时间：2024 年 1 月 3 日**

Alice 需要周转资金，但她的 VP 因为参与讨论尚未回满。她选择**分批次赎回**。

**关键规则：VP 是赎回本金的唯一凭证。**
_(发言消耗 VP = 暂时推迟赎回；保持沉默恢复 VP = 加速赎回)_

1.  **紧急提现 (Phase 1)**：

    - Alice 当前 VP 余额为 2000 (满额应为 3162)。
    - 她急需用钱，决定先兑现这部分。
    - **操作**：调用 `withdraw(fromVP=2000)`。
    - **系统计算**：根据曲线 $vDOT = (2000/100)^2 = 400$。
    - **结果**：Alice 拿走 400 vDOT，当前 VP 归零。此时她只拿回了 40% 的本金 (400/1000)，剩余 600 vDOT 仍锁定。

2.  **挂机回血 (Phase 2)**：

    - Alice 的账户并未销毁，依然享有“自然呼吸”权益。
    - 她选择**保持沉默**（不发帖），让 VP 自动恢复。
    - 速率：按初始质押权重，每小时恢复 316 VP。
    - 5 小时后，她恢复了 1580 VP。

3.  **最终离场 (Phase 3)**：
    - Alice 将恢复的 1580 VP 再次兑换。
    - **系统计算**：$vDOT = (1580/100)^2 \approx 250$。
    - 她再次提取 250 vDOT。
    - **循环**：她继续等待，直到累计提现金额达到初始投入的 1000 vDOT，账户正式关闭。

---

### 总结：V2 架构优势

- **极致体验**：发帖、点赞 0 等待、0 Gas。
- **成本极低**：只有 质押、提现、铸造 NFT 三步需要链上交易。
- **数据安全**：关键资产（vDOT/VP）和最终成果（NFT/精选集）全部在链上，中间过程高效链下处理。
